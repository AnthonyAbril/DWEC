<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buscaminas</title>
    <style>
      th {
        width: 20px;
        height: 20px;
        text-align: center;
        border: 1px solid black;
        background-color: grey;
      }
      #tablero {
        max-width: 100vw;
        max-height: 100vh;
        overflow: auto;
      }
      #tablero table {
        width: max-content;
      }
      p {
        display: inline-block;
      }
      #cuadro {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: red;
        text-align: center;
        padding: 5%;
      }
      button {
        padding: 10px 20px;
      }
    </style>
  </head>
  <body>
    <div id="barraSuperior">
      <p id="tiempo">Tiempo: 0</p>
      <p id="minas">Minas:</p>
      <p id="nivel"></p>
    </div>
    <div id="tablero"></div>
    <div id="cuadro">
      <h3>ELIGE EL NIVEL:</h3>
    </div>

    <script>
      //desactivamos el menu desplegable al pulsar click derecho
      document.addEventListener("contextmenu", (event) =>
        event.preventDefault()
      );

      //array de los distintos niveles con su numero de minas correspondiente y la cantidad maxima y minima de filas y columnas que puede haber
      let niveles = [
        ["Sencillo", 25, 10, 20],
        ["Normal", 60, 20, 40],
        ["Avanzado", 100, 40, 60],
        ["Experto", 140, 80, 100],
      ];

      //creamos las variables necesarias para el juego
      let nombre, minas, alto, ancho, mapaDeMinas, minasRestantes, perdido;
      
      //contador
      let intervalId,
        tiempo = 0;

      //funcion que devuelve una cantidad indicada de numeros aleatorios distintos cada uno entre si desde el 0 hasta el maximo indicado 
      function generarNumerosAleatoriosUnicos(cantidad, maxNumero) {
        const numeros = new Set();//crea un set
        while (numeros.size < cantidad) {
          numeros.add(Math.floor(Math.random() * maxNumero));
        }
        return Array.from(numeros);
      }

      //funcion que se ejecuta al perder (descubrir una mina)
      function perder() {
        alert("Has perdido");
        perdido = true;
        clearInterval(intervalId);
        document.querySelectorAll(".mina").forEach((element) => {
          element.style.backgroundColor = "red";
          element.querySelector("span").style.visibility = "visible";
        });
      }

      //funcion para descubrir las casillas adyacentes de una si esta vacia (0) e indicarles a estas que hagan lo mismo si son vacias tambien
      function descubrirAlrededores(posicion) {
        const casilla = document.getElementById(posicion);
        if (
          casilla.style.backgroundColor === "white" ||
          casilla.classList.contains("mina")
        )
          return;

        casilla.style.backgroundColor = "white";
        const contenido = casilla.querySelector("span");
        contenido.style.visibility = "visible";
        contenido.textContent = casilla.getAttribute("value");

        const valor = casilla.getAttribute("value");
        if (valor === "0") {
          let alrededores = [
            posicion - 1,
            posicion + 1,
            posicion - ancho,
            posicion + ancho,
            posicion - ancho - 1,
            posicion - ancho + 1,
            posicion + ancho - 1,
            posicion + ancho + 1,
          ];
          alrededores.forEach((adj) => {
            if (document.getElementById(adj)) descubrirAlrededores(adj);
          });
        }
      }

      //devuelve una casilla que compondran el tablero
      function crearCasilla(posicion) {
        const casilla = document.createElement("th");
        casilla.id = posicion;
        const contenido = document.createElement("span");
        contenido.style.visibility = "hidden";
        casilla.appendChild(contenido);

        if (mapaDeMinas.includes(posicion)) {
          casilla.classList.add("mina");
          casilla.setAttribute("value", "m");
        } else {
          let valor = minasCerca(posicion);
          casilla.setAttribute("value", valor);
        }

        let clickCount = 0;
        casilla.addEventListener("mousedown", (event) => {
          if (perdido) return;

          // Click izquierdo
          if (event.button === 0 && casilla.style.backgroundColor !== "white") {
            if (casilla.classList.contains("mina")) {
              perder();
            } else {
              descubrirAlrededores(posicion);
            }
          }
          // Click derecho para marcar o desmarcar
          else if (
            event.button === 2 &&
            casilla.style.backgroundColor !== "white"
          ) {
            clickCount = (clickCount + 1) % 3;
            if (clickCount === 1) {
              casilla.style.backgroundColor = "yellow";
              contenido.style.visibility = "visible"; 
              contenido.textContent = "?";
            } else if (clickCount === 2) {
              casilla.style.backgroundColor = "red";
              contenido.textContent = "M";
              minasRestantes--;
              document.getElementById("minas").textContent =
                "Minas restantes: " + minasRestantes;

              //revise si las asignadas (guardadas en un array elegidas por su atributo) son las mismas q el de mapa de minas
              if (minasRestantes == 0) {
                let minasMarcadas = [] //guarda la posicion de las minas marcadas al momento de llegar a 0
                
                ganar = true;

                //recorre el array de todas las minas
                document.querySelectorAll(".mina").forEach((element) => {
                  //si cada una de las minas ha sido marcada con M
                  if(element.querySelector("span").textContent = "M"){
                    minasMarcadas.push(element);//la guardamos en un array
                  }else{
                    ganar=false;
                  }
                });

                //si ninguna ha sido erronea
                if(ganar){
                  //se recorre el array de las marcadas
                  minasMarcadas.forEach((element) => {
                    element.style.backgroundColor = "green";
                  });
                  alert("has ganado");
                }

              }
            } else {
              casilla.style.backgroundColor = "grey";
              contenido.textContent = "";
              minasRestantes++;
              document.getElementById("minas").textContent =
                "Minas restantes: " + minasRestantes;
            }
          }
        });

        return casilla;
      }

      //Devuelve cuantas minas tiene cerca en base a la posicion
      function minasCerca(posicion) {
        const alrededores = [
          posicion - 1,
          posicion + 1,
          posicion - ancho,
          posicion + ancho,
          posicion - ancho - 1,
          posicion - ancho + 1,
          posicion + ancho - 1,
          posicion + ancho + 1,
        ];
        return alrededores.reduce(
          (cont, adj) => cont + mapaDeMinas.includes(adj),
          0
        );
      }

      //crea el tablero
      function crearTablero() {
        const tablero = document.getElementById("tablero");
        tablero.innerHTML = ""; // Limpia el tablero
        const tabla = document.createElement("table");
        for (let f = 0; f < alto; f++) {
          const fila = document.createElement("tr");
          for (let c = 0; c < ancho; c++) {
            const posicion = c + f * ancho;
            fila.appendChild(crearCasilla(posicion));
          }
          tabla.appendChild(fila);
        }
        tablero.appendChild(tabla);
      }

      //crea el selector de niveles que aparece al inicio
      function selectorDeNivel() {
        const cuadro = document.getElementById("cuadro");
        cuadro.style.visibility = "visible";
        document.getElementById("barraSuperior").style.visibility = "hidden";

        //creador de selector de nivel
        niveles.forEach((nivel) => {
          const boton = document.createElement("button");//creamos un boton para ese nivel
          boton.textContent = nivel[0]; //ponemos el nombre del nivel en el boton
          boton.addEventListener("click", () => {
            cuadro.style.visibility = "hidden";
            document.getElementById("barraSuperior").style.visibility =
              "visible";

            //sacar info de array
            nombre = nivel[0];
            minas = nivel[1];
            alto = Math.floor(Math.random() * (nivel[3] - nivel[2])) + nivel[2];
            ancho =
              Math.floor(Math.random() * (nivel[3] - nivel[2])) + nivel[2];
            minasRestantes = minas;
            perdido = false;
            tiempo = 0;

            mapaDeMinas = generarNumerosAleatoriosUnicos(minas, alto * ancho);//Las posiciones de las minas
            iniciarTemporizador();

            document.getElementById("nivel").textContent = "Nivel: " + nombre;
            document.getElementById("minas").textContent =
              "Minas: " + minasRestantes;
            crearTablero();
          });

          texto = document.createElement("p"); //creamos el texto de detalles del nivel
          lista =
            " entre " +
            nivel[2] +
            " y " +
            nivel[3] +
            " columnas y filas de manera aleatoria. " +
            nivel[1] +
            " minas.";
          texto.innerHTML = lista;

            
          cuadro.appendChild(boton); //se añade el boton al cuadro
          cuadro.appendChild(texto); //se añade el texto al cuadro
          cuadro.appendChild(document.createElement("br")); //salto de linea
        });
      }

      //inicia el temporizador y lo va indicando en la barra superior
      function iniciarTemporizador() {
        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(() => {
          document.getElementById("tiempo").textContent = "Tiempo: " + tiempo++;
        }, 1000);
      }

      selectorDeNivel();
    </script>
  </body>
</html>
