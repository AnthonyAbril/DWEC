<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buscaminas</title>
    <style>
      th {
        width: 20px;
        height: 20px;
        text-align: center;
        border: 1px solid black;
        background-color: grey;
      }
      #tablero {
        max-width: 100vw;
        max-height: 100vh;
        overflow: auto;
      }
      #tablero table {
        width: max-content;
      }
      p {
        display: inline-block;
      }
      #cuadro {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: red;
        text-align: center;
        padding: 5%;
      }
      button {
        padding: 10px 20px;
      }
    </style>
  </head>
  <body>
    <div id="barraSuperior">
      <p id="tiempo">Tiempo: 0</p>
      <p id="minas">Minas:</p>
      <p id="nivel"></p>
    </div>
    <div id="tablero"></div>
    <div id="cuadro">
      <h3>ELIGE EL NIVEL:</h3>
    </div>

    <script>
      document.addEventListener("contextmenu", (event) =>
        event.preventDefault()
      );

      let niveles = [
        ["Sencillo", 25, 10, 20],
        ["Normal", 60, 20, 40],
        ["Avanzado", 100, 40, 60],
        ["Experto", 140, 80, 100],
      ];

      let nombre, minas, alto, ancho, mapaDeMinas, minasRestantes, perdido;
      let intervalId,
        tiempo = 0;

      function generarNumerosAleatoriosUnicos(cantidad, maxNumero) {
        const numeros = new Set();
        while (numeros.size < cantidad) {
          numeros.add(Math.floor(Math.random() * maxNumero));
        }
        return Array.from(numeros);
      }

      function perder() {
        alert("Has perdido");
        perdido = true;
        clearInterval(intervalId);
        document.querySelectorAll(".mina").forEach((element) => {
          element.style.backgroundColor = "red";
          element.querySelector("span").style.visibility = "visible";
        });
      }

      function descubrirAlrededores(posicion) {
        const casilla = document.getElementById(posicion);
        if (
          casilla.style.backgroundColor === "white" ||
          casilla.classList.contains("mina")
        )
          return;

        casilla.style.backgroundColor = "white";
        const contenido = casilla.querySelector("span");
        contenido.style.visibility = "visible";
        contenido.textContent = casilla.getAttribute("value");

        const valor = casilla.getAttribute("value");
        if (valor === "0") {
          let alrededores = [
            posicion - 1,
            posicion + 1,
            posicion - ancho,
            posicion + ancho,
            posicion - ancho - 1,
            posicion - ancho + 1,
            posicion + ancho - 1,
            posicion + ancho + 1,
          ];
          alrededores.forEach((adj) => {
            if (document.getElementById(adj)) descubrirAlrededores(adj);
          });
        }
      }

      function crearCasilla(posicion) {
        const casilla = document.createElement("th");
        casilla.id = posicion;
        const contenido = document.createElement("span");
        contenido.style.visibility = "hidden";
        casilla.appendChild(contenido);

        if (mapaDeMinas.includes(posicion)) {
          casilla.classList.add("mina");
          casilla.setAttribute("value", "m");
        } else {
          let valor = minasCerca(posicion);
          casilla.setAttribute("value", valor);
        }

        let clickCount = 0;
        casilla.addEventListener("mousedown", (event) => {
          if (perdido) return;

          // Click izquierdo
          if (event.button === 0 && casilla.style.backgroundColor !== "white") {
            if (casilla.classList.contains("mina")) {
              perder();
            } else {
              descubrirAlrededores(posicion);
            }
          }
          // Click derecho para marcar o desmarcar
          else if (
            event.button === 2 &&
            casilla.style.backgroundColor !== "white"
          ) {
            clickCount = (clickCount + 1) % 3;
            if (clickCount === 1) {
              casilla.style.backgroundColor = "yellow";
              contenido.textContent = "?";
            } else if (clickCount === 2) {
              casilla.style.backgroundColor = "red";
              contenido.textContent = "M";
              minasRestantes--;
              document.getElementById("minas").textContent =
                "Minas restantes: " + minasRestantes;
              if (minasRestantes == 0) {
                //revise si las asignadas (guardadas en un array elegidas por su atributo) son las mismas q el de mapa de minas
              }
            } else {
              casilla.style.backgroundColor = "grey";
              contenido.textContent = "";
              minasRestantes++;
              document.getElementById("minas").textContent =
                "Minas restantes: " + minasRestantes;
            }
          }
        });

        return casilla;
      }

      function minasCerca(posicion) {
        const alrededores = [
          posicion - 1,
          posicion + 1,
          posicion - ancho,
          posicion + ancho,
          posicion - ancho - 1,
          posicion - ancho + 1,
          posicion + ancho - 1,
          posicion + ancho + 1,
        ];
        return alrededores.reduce(
          (cont, adj) => cont + mapaDeMinas.includes(adj),
          0
        );
      }

      function crearTablero() {
        const tablero = document.getElementById("tablero");
        tablero.innerHTML = ""; // Limpia el tablero
        const tabla = document.createElement("table");
        for (let f = 0; f < alto; f++) {
          const fila = document.createElement("tr");
          for (let c = 0; c < ancho; c++) {
            const posicion = c + f * ancho;
            fila.appendChild(crearCasilla(posicion));
          }
          tabla.appendChild(fila);
        }
        tablero.appendChild(tabla);
      }

      function selectorDeNivel() {
        const cuadro = document.getElementById("cuadro");
        cuadro.style.visibility = "visible";
        document.getElementById("barraSuperior").style.visibility = "hidden";

        niveles.forEach((nivel) => {
          const boton = document.createElement("button");
          boton.textContent = nivel[0];
          boton.addEventListener("click", () => {
            cuadro.style.visibility = "hidden";
            document.getElementById("barraSuperior").style.visibility =
              "visible";

            nombre = nivel[0];
            minas = nivel[1];
            alto = Math.floor(Math.random() * (nivel[3] - nivel[2])) + nivel[2];
            ancho =
              Math.floor(Math.random() * (nivel[3] - nivel[2])) + nivel[2];
            minasRestantes = minas;
            perdido = false;
            tiempo = 0;

            mapaDeMinas = generarNumerosAleatoriosUnicos(minas, alto * ancho);
            iniciarTemporizador();

            document.getElementById("nivel").textContent = "Nivel: " + nombre;
            document.getElementById("minas").textContent =
              "Minas: " + minasRestantes;
            crearTablero();
          });
          cuadro.appendChild(boton);
          cuadro.appendChild(document.createElement("br"));
        });
      }

      function iniciarTemporizador() {
        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(() => {
          document.getElementById("tiempo").textContent = "Tiempo: " + tiempo++;
        }, 1000);
      }

      selectorDeNivel();
    </script>
  </body>
</html>
