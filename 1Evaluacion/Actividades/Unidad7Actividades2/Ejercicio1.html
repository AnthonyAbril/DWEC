<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #creadorDeEmpleado {
        visibility: hidden;
        background-color: red;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        padding: 10px;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <!--
        PODMAN
        podman rm servidor-php
        podman run -it -p 8080:80 --name servidor-php -v ./:/var/www/html docker.io/jtarrega/lamp:1.0
        service apache2 start

        Crear una aplicación CRUD que permita listar, insertar, modificar y borrar empleados de una 
        base de datos remota utilizando una API RESTFUL y con formato de intercambio de datos 
        JSON. La API tiene que recibir todas las peticiones en AJAX. Los “endpoint” de la API son:

        "GET", http://test-api.jtarrega.es/api/empleados 
            Devuelve un array, en que cada elemento es un JSON con los datos de un empleado: 
            
        "GET", http://test-api.jtarrega.es/api/empleados/{idempleado} 
            Devuelve  un  array,  con  un  solo  elemento  que  es  un  JSON  con  los  datos  del  empleado 
            solicitado en “idempleado”: 

        Estos dos primeros “endpoint” devuelven 200 en status si todo ha ido bien. 

        "POST", http://test-api.jtarrega.es/api/empleados 
            Permite introducir un nuevo empleado en la BBDD, no se le enviará el id porque lo genera 
            automáticamente, podemos utilizar para ello: 
            // Objeto JavaScript 
                const dataToSend = { 
                    nombre: formulario.nombre.value, 
                    edad: formulario.edad.value, 
                    cargo: formulario.cargo.value, 
                    contratado: formulario.contratado.checked ? 1 : 0 
                }; 
                // Convertir a JSON 
                const jsonData = JSON.stringify(dataToSend); 
            Si todo va bien devuelve 200 o 201 en status y se habrá insertado el nuevo registro. 
        
        "PUT", http://test-api.jtarrega.es/api/empleados/{idempleado} 
            Permite modificar el registro en la BBDD con id=idempleado con los datos que le pasemos 
            en el JSON (podemos usar el mismo objeto que el visto en el anterior) 
            Si todo va bien devuelve 200 o 201 en status y se habrá modificado el registro con los 
            datos proporcionados 
        
        "DELETE", http://test-api.jtarrega.es/api/empleados/{idempleado} 
            Permite borrar el registro en la BBDD con id=idempleado. No necesitamos pasarle datos 
            en JSON. Funciona como el GET que obtenía un elemento. 
            Si todo va bien devuelve 200, 201 o 204 en status y se habrá eliminado el registro con el id 
            proporcinado. 
    -->
    <h1>Gestión de Empleados</h1>
    <div id="caja">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Cargo</th>
            <th>Contratado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listaEmpleados"></tbody>
      </table>
    </div>
    <div id="creadorDeEmpleado">
      <form>
        <h1>Nuevo Empleado</h1>
        <fieldset>
          <legend>Introduce datos</legend>
          <label for="nombre">Nombre: </label>
          <input type="text" id="nombre" />
          <br />
          <label for="edad">Edad: </label>
          <input type="number" id="edad" />
          <br />
          <label for="cargo">Cargo: </label>
          <input type="text" id="cargo" />
          <br />
          <label for="contratado">Empleado contratado: </label>
          <input type="checkbox" id="contratado" />
          <br />
          <input type="submit" value="Aceptar" onclick="crearEmpleado()" />
          <input
            type="submit"
            value="Borrar"
            onclick="document.getElementById('creadorDeEmpleado').visibility = 'hidden';"
          />
        </fieldset>
      </form>
    </div>
    <script>
      peticion = new XMLHttpRequest();

      //abre el creador de empleados
      function creadorEmpleado() {
        formulario = document.getElementById("creadorDeEmpleado");
        formulario.style.visibility = "visible";
        formulario = formulario.firstChild;

        // Escucha el evento submit
        formulario.addEventListener("submit", function (evento) {
          // Evitar que se envíe el formulario y recargue la página
          evento.preventDefault();

          /*
          const datosFormulario = new FormData(formulario);
          // Convertir FormData a JSON
          const datosJSON = Object.fromEntries(datosFormulario.entries());
        */
          const dataToSend = {
            nombre: formulario.nombre.value,
            edad: formulario.edad.value,
            cargo: formulario.cargo.value,
            contratado: formulario.contratado.checked ? 1 : 0,
          };
          // Convertir a JSON
          const jsonData = JSON.stringify(dataToSend);

          // Enviar los datos al servidor
          // Configurar la solicitud: método y URL
          peticion.open(
            "POST",
            "http://test-api.jtarrega.es/api/empleados",
            true
          );

          // Establecer el encabezado si envías JSON
          peticion.setRequestHeader("Content-Type", "application/json");

          // Manejar la respuesta del servidor
          peticion.onload = function () {
            if (peticion.status === 200) {
              // Analiza la respuesta si es JSON
              const respuesta = JSON.parse(peticion.responseText);
              console.log("Respuesta del servidor:", respuesta);
            } else {
              console.error("Error en la solicitud:", peticion.statusText);
            }
          };

          // Manejar errores
          peticion.onerror = function () {
            console.error("Error de conexión o de red.");
          };

          // Enviar la solicitud con los datos
          peticion.send(JSON.stringify(datosJSON));
        });
      }

      //establecemos el metodo que se ejecutara cuando cambie el estado de la peticion
      peticion.onreadystatechange = function () {
        //si la solicitud ha sido completada y el servidor responde que la solicitud fue exitosa.
        if (peticion.readyState == 4 && peticion.status == 200) {
          let respuesta = peticion.responseText; // Contiene la respuesta como texto.
          console.log("Datos recibidos:", respuesta);

          // Convertir la respuesta JSON en un objeto de JavaScript
          let datos = JSON.parse(respuesta); // Si la respuesta es JSON, parsearla.
          console.log("Empleados:", datos);

          //por cada empleado
          for (var i = 0; i < datos.length; i++) {
            var empleado = datos[i];

            listarEmpleado(empleado);
          }

          crearNuevoEmpleado = document.createElement("button");
          crearNuevoEmpleado.innerText = "CREAR NUEVO EMPLEADO";
          crearNuevoEmpleado.addEventListener("click", () => {
            creadorEmpleado();
          });
          document.body.appendChild(crearNuevoEmpleado);
        }
      };

      //se abre y configura la peticion
      peticion.open("GET", "http://test-api.jtarrega.es/api/empleados", true);

      //se encia la peticion
      peticion.send();

      function listarEmpleado(empleado) {
        var idEmpleado = empleado.id;
        var nombreEmpleado = empleado.nombre;
        var cargoEmpleado = empleado.cargo;
        var edadEmpleado = empleado.edad;
        var contratadoEmpleado = empleado.contratado;

        lista = document.getElementById("listaEmpleados");

        //fila por cada empleado
        filaEmpleado = document.createElement("tr");

        atributos = 0;
        //celda por cada atributo
        for (let clave in empleado) {
          if (atributos < 5) {
            //celda por cada atributo
            celda = document.createElement("th");

            //introduce info
            celda.innerText = empleado[clave];
            atributos++;

            //se añade al documento
            filaEmpleado.appendChild(celda);
          }
        }

        //añadimos los botones
        celda = document.createElement("th");
        modificar = document.createElement("button");
        modificar.innerText = "modificar";
        borrar = document.createElement("button");
        borrar.innerText = "borrar";
        celda.appendChild(modificar);
        celda.appendChild(borrar);
        filaEmpleado.appendChild(celda);

        lista.appendChild(filaEmpleado);
      }
    </script>
  </body>
</html>
