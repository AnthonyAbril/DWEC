<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #creadorDeEmpleado {
        visibility: hidden;
        background-color: red;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        padding: 10px;
        border-radius: 10px;
      }
    </style>
  </head>
  <body
    onload="
      IniciarTablero()"
  >
    <h1>Gestión de Empleados</h1>
    <div id="caja">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Cargo</th>
            <th>Contratado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listaEmpleados"></tbody>
      </table>
      <button onclick="creadorEmpleado()">CREAR NUEVO EMPLEADO</button>
    </div>
    <div id="creadorDeEmpleado">
      <form id="formEmpleado">
        <h1>Nuevo Empleado</h1>
        <fieldset>
          <legend>Introduce datos</legend>
          <label for="nombre">Nombre: </label>
          <input type="text" id="nombre" />
          <br />
          <label for="edad">Edad: </label>
          <input type="number" id="edad" />
          <br />
          <label for="cargo">Cargo: </label>
          <input type="text" id="cargo" />
          <br />
          <label for="contratado">Empleado contratado: </label>
          <input type="checkbox" id="contratado" />
          <br />
          <input type="submit" value="Aceptar" />
          <input type="submit" value="Cancelar" />
        </fieldset>
      </form>
    </div>

    <script>
      //abre el creador de empleados
      function creadorEmpleado() {
        const formulario = document.getElementById("creadorDeEmpleado");
        formulario.style.visibility = "visible";
        const form = document.getElementById("formEmpleado");

        // Escucha el evento submit
        form.addEventListener("submit", function (evento) {
          // Evitar que se envíe el formulario y recargue la página
          evento.preventDefault();

          const action = event.submitter.value; // Captura el botón presionado

          //si le da a aceptar
          if (action == "Aceptar") {
            //guardamos los datos
            let datosEmpleado = {
              nombre: form.nombre.value,
              edad: document.getElementById("edad").value,
              cargo: document.getElementById("cargo").value,
              contratado: document.getElementById("contratado").checked ? 1 : 0,
            };

            //pasamos los datos a json
            const jsonData = JSON.stringify(datosEmpleado);

            let peticion = new XMLHttpRequest();

            // Aquí puedes enviar los datos al servidor
            peticion.open(
              "POST",
              "http://test-api.jtarrega.es/api/empleados",
              true
            );
            peticion.setRequestHeader("Content-Type", "application/json");

            peticion.onload = function () {
              if (peticion.status === 200 || peticion.status === 201) {
                console.log("Empleado añadido:", peticion.responseText);
                // Aquí puedes hacer algo con la respuesta, como actualizar la lista de empleados.

                let respuesta = peticion.responseText; // Contiene la respuesta como texto.
                crearListaEmpleados(respuesta);
              } else {
                console.error("Error en la solicitud:", peticion.statusText);
              }
            };

            peticion.send(jsonData);

            form.reset();
          }

          // Ocultar el formulario después de enviar
          formulario.style.visibility = "hidden";

          //refrescamos lista
          IniciarTablero();
        });
      }

      function listarEmpleado(empleado) {
        var idEmpleado = empleado.id;
        var nombreEmpleado = empleado.nombre;
        var cargoEmpleado = empleado.cargo;
        var edadEmpleado = empleado.edad;
        var contratadoEmpleado = empleado.contratado;

        let lista = document.getElementById("listaEmpleados");

        //fila por cada empleado
        filaEmpleado = document.createElement("tr");

        atributos = 0;
        //celda por cada atributo
        for (let clave in empleado) {
          if (atributos < 5) {
            //celda por cada atributo
            celda = document.createElement("th");

            //introduce info
            celda.innerText = empleado[clave];
            atributos++;

            //se añade al documento
            filaEmpleado.appendChild(celda);
          }
        }

        //añadimos los botones
        celda = document.createElement("th");

        modificar = document.createElement("button");
        modificar.innerText = "modificar";

        borrar = document.createElement("button");
        borrar.innerText = "borrar";
        borrar.addEventListener("click", function (event) {
          event.preventDefault();

          let peticion = new XMLHttpRequest();

          peticion.open(
            "DELETE",
            "http://test-api.jtarrega.es/api/empleados/" + idEmpleado,
            false
          ); // abrimos peticon con el id del empleado

          console.log("Peticion eliminar empleado abierta");

          peticion.onreadystatechange = function () {
            if (
              peticion.readyState == 4 &&
              (peticion.status == 200 ||
                peticion.status == 201 ||
                peticion.status == 204)
            ) {
              console.log("Peticion realizada");
              IniciarTablero();
            }
          };
          peticion.send();
        });

        celda.appendChild(modificar);
        celda.appendChild(borrar);
        filaEmpleado.appendChild(celda);

        lista.appendChild(filaEmpleado);
      }

      function crearListaEmpleados(respuesta) {
        // Convertir la respuesta JSON en un objeto de JavaScript
        let datos = JSON.parse(respuesta); // Si la respuesta es JSON, parsearla.

        console.log(datos);
        //por cada empleado
        for (var i = 0; i < datos.length; i++) {
          var empleado = datos[i];

          listarEmpleado(empleado);
        }
      }

      function IniciarTablero() {
        document.getElementById("listaEmpleados").innerHTML = "";

        let peticion = new XMLHttpRequest();
        //establecemos el metodo que se ejecutara cuando cambie el estado de la peticion
        peticion.onreadystatechange = function () {
          //si la solicitud ha sido completada y el servidor responde que la solicitud fue exitosa.
          if (peticion.readyState == 4 && peticion.status == 200) {
            let respuesta = peticion.responseText; // Contiene la respuesta como texto.

            crearListaEmpleados(respuesta);
          }
        };

        peticion.open("GET", "http://test-api.jtarrega.es/api/empleados", true);
        peticion.send();
      }
    </script>
  </body>
</html>
